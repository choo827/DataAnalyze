---
title: "ì„¸ê³„ í–‰ë³µ ë³´ê³ ì„œ 2023 ë¶„ì„"
output: html_document
---
í•™ê³¼: í†µê³„í•™ê³¼


í•™ë²ˆ: 202104241


ì´ë¦„: ì¶”ìŠ¹ì›

* * *
### ëª©ì°¨
0. ë°ì´í„° ì¤€ë¹„í•˜ê¸°
1. 2023 ë³´ê³ ì„œ ë³€ê²½ì 
2. ì„¸ê³„ì—ì„œ ê°€ì¥ í–‰ë³µí•œ 10ê°œêµ­
3. ì„¸ê³„ì—ì„œ ê°€ì¥ ìŠ¬í”ˆ 10ê°œêµ­
4. ì„¸ê³„ ì§€ì—­ë³„ í–‰ë³µì§€ìˆ˜
5. ìƒê´€ê´€ê³„ ë¶„ì„
6. ì£¼ìš” ìš”ì¸

* * *

## 0. ë°ì´í„° ì¤€ë¹„í•˜ê¸°
* 2021 ë³´ê³ ì„œì™€ 2023 ë³´ê³ ì„œ êµ­ê°€ ë¹„êµ
* ê²°ì¸¡ì¹˜ í™•ì¸
* 2023 ë³´ê³ ì„œì— Regional indicator ì—´ ì¶”ê°€
```{r}
library(tidyverse)
library(ggchicklet)
library(cowplot)
library(waffle)
library(hrbrthemes)
library(ggalt)
library(GGally)
library(rwa)
```

```{r}
# 2021 ë³´ê³ ì„œì™€ 2023 ë³´ê³ ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
df_2021 <- read.csv("/Users/choo827/DataspellProjects/Test/world-happiness-report-2021.csv")
df_2023 <- read.csv("/Users/choo827/DataspellProjects/Test/WHR2023.csv")

# 2021 ë³´ê³ ì„œì— ìˆëŠ” êµ­ê°€ê°€ 2023 ë³´ê³ ì„œ ì•ˆì— ìˆìœ¼ë©´ Yesë¥¼ ë°˜í™˜, ì—†ìœ¼ë©´ âŒë¥¼ ë°˜í™˜
ifelse(df_2021$Country.name %in% df_2023$Country.name, "Yes", "âŒ")

# 2023 ë³´ê³ ì„œì— ìˆëŠ” êµ­ê°€ê°€ 2021 ë³´ê³ ì„œ ì•ˆì— ìˆìœ¼ë©´ Yesë¥¼ ë°˜í™˜, ì—†ìœ¼ë©´ âŒë¥¼ ë°˜í™˜
ifelse(df_2023$Country.name %in% df_2021$Country.name, "Yes", "âŒ")

```
```{r}
# ê²°ì¸¡ì¹˜ í™•ì¸
sum(is.na(df_2021))
sum(is.na(df_2023))
```
> State of Palestineì˜ ë°ì´í„° 3ê°œê°€ NAì¸ ê²ƒì„ í™•ì¸. 2021 ë³´ê³ ì„œ ë°ì´í„° ê°’ìœ¼ë¡œ ì…ë ¥
```{r}
# Regional indicator ì—´ì„ ì¶”ê°€í•œ 2023 ë³´ê³ ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
df_new2023 <- read.csv("/Users/choo827/DataspellProjects/Test/new_WHR2023.csv")

# ê²°ì¸¡ì¹˜ í™•ì¸
sum(is.na(df_new2023))
```
## 1. 2023 ë³´ê³ ì„œ ë³€ê²½ì 
#### ì´ë¦„ì´ ë³€ê²½ëœ êµ­ê°€
1. ğŸ‡¨ğŸ‡¿Czech Republic â¡ï¸ Czechia
2. ğŸ‡µğŸ‡¸Palestinian Territories â¡ï¸ State of Palestine
3. ğŸ‡¹ğŸ‡·Turkey â¡ï¸ Turkiye

#### ê¸°ë¡ì´ ì¶”ê°€ëœ êµ­ê°€
1. ğŸ‡¨ğŸ‡©Congo (Kinshasa)

#### ê¸°ë¡ì´ ì‚­ì œëœ êµ­ê°€
1. ğŸ‡¦ğŸ‡¿Azerbaijan
2. ğŸ‡§ğŸ‡¾Belarus
3. Burundi
4. ğŸ‡­ğŸ‡¹Haiti
5. ğŸ‡°ğŸ‡¼Kuwait
6. ğŸ‡±ğŸ‡¸Lesotho
7. ğŸ‡±ğŸ‡¾Libya
8. ğŸ‡²ğŸ‡»Maldives
9. ğŸ‡¨ğŸ‡¾North Cyprus
10. ğŸ‡·ğŸ‡¼Rwanda
11. ğŸ‡¸ğŸ‡¿Swaziland
12. ğŸ‡¹ğŸ‡²Turkmenistan
13. ğŸ‡¾ğŸ‡ªYemen

* * *

## 2. ì„¸ê³„ì—ì„œ ê°€ì¥ í–‰ë³µí•œ 10ê°œêµ­
```{r}
dimensions <- c('Ladder.score', 'Logged.GDP.per.capita', 'Social.support', 'Healthy.life.expectancy', 'Freedom.to.make.life.choices', 'Generosity', 'Perceptions.of.corruption')

# map country to regions
country_region_dict <- df_new2023 %>%
  select(country = Country.name, region = Regional.indicator) %>%
  unique()

df_new2023_long <- df_new2023 %>%
  select(country = Country.name, all_of(dimensions)) %>%
  mutate(absence_of_corruption = 1 - Perceptions.of.corruption) %>%
  pivot_longer(cols = c(all_of(dimensions), 'absence_of_corruption'), names_to = 'dimension', values_to = 'score') %>%
  filter(dimension != "Perceptions.of.corruption")

df_new2023_tranformed <- df_new2023_long %>%
  group_by(dimension) %>%
  mutate(min_value = min(score),
         max_value = max(score)) %>%
  mutate(score_pct = (score - min_value) / (max_value - min_value)) %>%
  ungroup()

# get top 10
df_new2023_top10 <- df_new2023_tranformed %>%
  filter(dimension == "Ladder.score") %>%
  slice_max(score, n = 10) %>%
  mutate(cat = 'top_10',
         country_rank = rank(-score),
         country_label = paste0(country, ' (', country_rank, ')'))

ggplot(df_new2023_top10, aes(x = reorder(country_label, score))) +
  geom_chicklet(aes(y = 10, fill = 4.9), width = 0.75, radius = grid::unit(2, "pt")) +
  geom_chicklet(aes(y = score, fill = score), width = 0.75, radius = grid::unit(2, "pt")) +
  geom_text(aes(y = score), label = round(df_new2023_top10$score, 2), nudge_y = 0.4, size = 4) +
  scale_y_continuous(expand = c(0, 0.1), position = "right", limits = c(0, 10)) +
  scale_fill_gradient2(low = 'black', high = '#4dbb5f', mid = 'white', midpoint = 5) +
  coord_flip() +
  labs(y = "Best possible life = 10", x = '',
       title = "10 Happiest Countries in the World",
       caption = "Source: The World Happiness Report 2023") +
  theme_ipsum(grid = '') +
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 10),
        axis.title.x = element_text(size = 10, color = '#aaaaaa'),
        axis.text.y = element_text(size = 12, color = 'black'),
        axis.text.x = element_blank(),
        legend.position = 'None')

```

ìƒìœ„ 10ê°œ êµ­ê°€ ì¤‘ 9ê°œ êµ­ê°€ê°€ ìœ ëŸ½ì— ì†í•´ ìˆìŒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


* * *
## 3. ì„¸ê³„ì—ì„œ ê°€ì¥ ìŠ¬í”ˆ 10ê°œêµ­

```{r}
# get bottom 10
df_new2023_bottom10 <- df_new2023_tranformed %>%
  filter(dimension == "Ladder.score") %>%
  mutate(country_rank = rank(score),
         country_label = paste0(country, ' (', country_rank, ')')) %>%
  slice_min(score, n = 10) %>%
  mutate(cat = 'bottom_10')

ggplot(df_new2023_bottom10, aes(x = reorder(country_label, score))) +
  geom_chicklet(aes(y = 10, fill = 4.9), width = 0.75, radius = grid::unit(2, "pt")) +
  geom_chicklet(aes(y = score, fill = score), width = 0.75, radius = grid::unit(2, "pt")) +
  geom_text(aes(y = score), label = round(df_new2023_bottom10$score, 2), nudge_y = 0.4, size = 4) +
  scale_y_continuous(expand = c(0, 0.1), position = "right", limits = c(0, 10)) +
  scale_fill_gradient2(low = 'black', high = '#7FB185', mid = 'white', midpoint = 5) +
  coord_flip() +
  labs(y = "Best possible life = 10", x = '',
       title = "10 Saddest Countries in the World",
       caption = "Source: The World Happiness Report 2023") +
  theme_ipsum(grid = '') +
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 10),
        axis.title.x = element_text(size = 10, color = '#aaaaaa'),
        axis.text.y = element_text(size = 12, color = 'black'),
        axis.text.x = element_blank(),
        legend.position = 'None')
```

í•˜ìœ„ 10ê°œ êµ­ê°€ ì¤‘ 7ê°œ êµ­ê°€ê°€ ì•„í”„ë¦¬ì¹´ì— ì†í•´ ìˆìŠµë‹ˆë‹¤. ë” ìì„¸íˆ ì•Œì•„ë³´ê¸° ìœ„í•´ ì§€ì—­ë³„ í–‰ë³µì§€ìˆ˜ë¥¼ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

* * *

## 4. ì„¸ê³„ ì§€ì—­ë³„ í–‰ë³µì§€ìˆ˜
```{r}

df_waffle <- df_new2023_tranformed %>%
  filter(dimension == 'Ladder.score') %>%
  left_join(country_region_dict, by = 'country') %>%
  mutate(score_bin = cut(score, seq(2, 8, 1), right = FALSE)) %>%
  group_by(region) %>%
  mutate(region_avg = mean(score)) %>%
  ungroup() %>%
  mutate(region = reorder(region, region_avg)) %>%
  count(region, score_bin) %>%
  arrange(score_bin, n)

score_levels <- levels(df_waffle$score_bin)

pal <- colorRampPalette(c("black", "white", "#7FB185"))

ggplot(df_waffle, aes(fill = score_bin, values = n)) +
  geom_waffle(color = "white", size = 0.33, n_rows = 6, flip = TRUE, na.rm = FALSE, radius = unit(2, "pt")) +
  facet_wrap(~region, nrow = 2, strip.position = "bottom", labeller = label_wrap_gen()) +
  scale_x_discrete() +
  scale_y_continuous(labels = function(x) x * 6, # make this multiplyer the same as n_rows
                     expand = c(0, 0),
                     limits = c(0, 7)) +
  scale_fill_manual(
    name = "Green indicates more happiness",
    values = pal(6),
    labels = c('', '', '', '', '', '')
  ) +
  coord_equal() +
  labs(
    title = "Happiness by World Region",
    caption = "1 square = a country\nSource: The World Happiness Report 2023",
    y = "Country Count"
  ) +
  theme_ipsum(grid = '') +
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 10),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 10),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_blank(),
        strip.text.x = element_text(size = 10),
        legend.position = "top",
        legend.box = 'vertical',
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 8)) +
  guides(fill = guide_legend(reverse = FALSE, nrow = 1, byrow = TRUE))
```

ê°€ì¥ í–‰ë³µí•œ ì§€ì—­ì€ ë¶ë¯¸ì™€ ì„œìœ ëŸ½ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* * *

## 5. ìƒê´€ê´€ê³„ ë¶„ì„
```{r}
df_cor <- df_new2023 %>%
  select(corruption = Perceptions.of.corruption,
         generosity = Generosity,
         freedom = Freedom.to.make.life.choices,
         life_expectancy = Healthy.life.expectancy,
         social_support = Social.support,
         GDP_per_capita = Logged.GDP.per.capita,
         happiness = Ladder.score
  )

ggcorr(df_cor,
       method = c("everything", "pearson"),
       size = 4, hjust = 0.77,
       low = '#ff0000', mid = 'white', high = "#2e8b57",
       label = TRUE, label_size = 4,
       layout.exp = 1) +
  labs(title = 'Correlation Matrix',) +
  theme_ipsum()
```

í–‰ë³µì€ 1. ë¶€(GDP), 2. ê±´ê°•, 3. ì‚¬íšŒì  ì§€ì›, 4. ììœ ì™€ ê°€ì¥ ë°€ì ‘í•œ ìƒê´€ê´€ê³„ê°€ ìˆìŒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* * *

## 6. ì£¼ìš” ìš”ì¸ ë¶„ì„

```{r}
predictors <- colnames(df_cor)[1:6]
outcome <- 'happiness'
rwa <- rwa(df_cor,
           outcome = outcome,
           predictors = predictors,
           applysigns = FALSE)

rsquare <- rwa$rsquare
(relative_weight <- rwa$result)
n <- rwa$n

ggplot(relative_weight, aes(x = reorder(Variables, Rescaled.RelWeight), y = Rescaled.RelWeight, fill = Rescaled.RelWeight)) +
  geom_chicklet(width = 0.75, radius = grid::unit(2, "pt")) +
  geom_text(label = paste0(round(relative_weight$Rescaled.RelWeight, 0), "%"), nudge_y = 0.4, size = 4) +
  scale_y_continuous(expand = c(0, 0.2), limits = c(0, 40)) +
  scale_fill_gradient(low = 'white', high = '#7FB185') +
  coord_flip() +
  labs(y = "Rescaled Relative Weights", x = '',
       title = "Variable importance estimates",
       caption = paste0("Note: Recaled Relative Weights sum to 100%. n = ", n, '. R-squared:', round(rsquare, 2))) +
  theme_ipsum(grid = '') +
  theme(plot.title = element_text(size = 20),
        plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.text.y = element_text(size = 12, color = 'black'),
        axis.text.x = element_blank(),
        legend.position = 'None')
```

í–‰ë³µì— ì¤‘ìš”í•œ 3ê°€ì§€ ìš”ì¸:

1. ì‚¬íšŒì  ì§€ì›
2. GDP
3. ììœ , ê¸°ëŒ€ìˆ˜ëª…
ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* * *

### 2023 ì„¸ê³„ í–‰ë³µ ë³´ê³ ì„œë¡œ ì•Œê²Œëœ ì 
ì„¸ê³„ì—ì„œ ê°€ì¥ í–‰ë³µí•œ ì§€ì—­ì€ ë¶ë¯¸ì™€ ì„œìœ ëŸ½ì…ë‹ˆë‹¤.


í–‰ë³µì— ì¤‘ìš”í•œ 3ê°€ì§€ ì£¼ìš” ìš”ì¸:

1. ì‚¬íšŒì  ì§€ì›
2. GDP
3. ììœ , ê¸°ëŒ€ìˆ˜ëª…



